<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="../favicon.ico" sizes="any">
    <link rel="icon" href="../favicon.svg" type="image/svg+xml">
    <title>Spotify Liked Songs Analyzer</title>
    <style>
 :root{ --primary-color: #1db954; --secondary-color: #191414; --accent-color: #1ed760; --text-primary: #ffffff; --text-secondary: #b3b3b3; --background-dark: #121212; --background-card: #181818; --border-color: #282828; --error-color: #e22134; --success-color: #1db954;} *{ margin: 0; padding: 0; box-sizing: border-box;} body{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, var(--background-dark) 0%, var(--secondary-color) 100%); color: var(--text-primary); line-height: 1.6; min-height: 100vh;} .container{ max-width: 1400px; margin: 0 auto; padding: 20px;} .header{ text-align: center; margin-bottom: 40px; padding: 40px 0; background: rgba(29, 185, 84, 0.1); border-radius: 16px; backdrop-filter: blur(10px);} .header h1{ font-size: 3rem; font-weight: 700; margin-bottom: 10px; background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;} .header p{ color: var(--text-secondary); font-size: 1.1rem;} .upload-section{ background: var(--background-card); border-radius: 16px; padding: 40px; margin-bottom: 30px; border: 2px dashed var(--border-color); transition: all 0.3s ease; text-align: center;} .upload-section:hover{ border-color: var(--primary-color); background: rgba(29, 185, 84, 0.05);} .upload-area{ position: relative; cursor: pointer;} .upload-icon{ font-size: 3rem; color: var(--primary-color); margin-bottom: 20px;} .file-input{ position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;} .upload-text{ font-size: 1.2rem; margin-bottom: 10px;} .upload-subtext{ color: var(--text-secondary); font-size: 0.9rem;} .stats-grid{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;} .stat-card{ background: var(--background-card); border-radius: 12px; padding: 25px; text-align: center; border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease;} .stat-card:hover{ transform: translateY(-5px); box-shadow: 0 10px 30px rgba(29, 185, 84, 0.2);} .stat-value{ font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px;} .stat-label{ color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;} .controls{ display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; align-items: center;} .search-box{ flex: 1; min-width: 250px; padding: 12px 20px; background: var(--background-card); border: 1px solid var(--border-color); border-radius: 25px; color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease;} .search-box:focus{ outline: none; border-color: var(--primary-color);} .btn{ padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;} .btn:hover{ background: var(--accent-color); transform: translateY(-2px);} .btn-secondary{ background: transparent; border: 1px solid var(--border-color); color: var(--text-primary);} .btn-secondary:hover{ border-color: var(--primary-color); color: var(--primary-color);} .songs-container{ background: var(--background-card); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden;} .songs-header{ display: grid; grid-template-columns: 60px 1fr 200px 150px 100px 80px; gap: 20px; padding: 20px; background: rgba(29, 185, 84, 0.1); color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;} .song-item{ display: grid; grid-template-columns: 60px 1fr 200px 150px 100px 80px; gap: 20px; padding: 15px 20px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; align-items: center;} .song-item:hover{ background: rgba(255, 255, 255, 0.05);} .song-item:last-child{ border-bottom: none;} .album-art{ width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: var(--border-color);} .song-info h3{ font-size: 1rem; margin-bottom: 5px; cursor: pointer;} .song-info h3:hover{ color: var(--primary-color);} .song-info p{ color: var(--text-secondary); font-size: 0.9rem;} .copy-btn{ padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 15px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease;} .copy-btn:hover{ border-color: var(--primary-color); color: var(--primary-color);} .popularity-bar{ width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;} .popularity-fill{ height: 100%; background: linear-gradient(90deg, var(--error-color), var(--primary-color)); transition: width 0.3s ease;} .hidden{ display: none !important;} .loading{ text-align: center; padding: 40px; color: var(--text-secondary);} .spinner{ display: inline-block; width: 40px; height: 40px; border: 3px solid var(--border-color); border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;} @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);}} .toast{ position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: var(--success-color); color: white; border-radius: 8px; font-weight: 600; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease;} .toast.show{ transform: translateX(0);} .export-options{ margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;} @media (max-width: 768px){ .songs-header, .song-item{ grid-template-columns: 50px 1fr 80px; gap: 15px;} .songs-header span:nth-child(3), .songs-header span:nth-child(4), .songs-header span:nth-child(5), .song-item >*:nth-child(3), .song-item >*:nth-child(4), .song-item >*:nth-child(5){ display: none;} .header h1{ font-size: 2rem;} .controls{ flex-direction: column; align-items: stretch;}} .filter-section{ background: var(--background-card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color);} .filter-title{ font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--primary-color);} .filter-grid{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;} .filter-group label{ display: block; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;} .filter-group select, .filter-group input{ width: 100%; padding: 8px 12px; background: var(--background-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.9rem;} .chart-container{ background: var(--background-card); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color);} .chart-title{ font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; color: var(--primary-color); text-align: center;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Spotify Analyzer</h1>
            <p>Upload your liked songs CSV to discover insights about your music taste</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your CSV file here or click to browse</div>
                <div class="upload-subtext">Supports CSV files up to 10MB</div>
                <input type="file" class="file-input" id="fileInput" accept=".csv" />
            </div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your music collection...</p>
        </div>

        <div class="hidden" id="dataSection">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>

            <div class="filter-section">
                <div class="filter-title">üîç Filters & Search</div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="searchInput">Search Songs/Artists</label>
                        <input type="text" id="searchInput" placeholder="Search..." class="search-box">
                    </div>
                    <div class="filter-group">
                        <label for="yearFilter">Release Year</label>
                        <select id="yearFilter">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="popularityFilter">Min Popularity</label>
                        <input type="range" id="popularityFilter" min="0" max="100" value="0">
                        <span id="popularityValue">0</span>
                    </div>
                    <div class="filter-group">
                        <label for="sortBy">Sort By</label>
                        <select id="sortBy">
                            <option value="added">Recently Added</option>
                            <option value="popularity">Popularity</option>
                            <option value="artist">Artist Name</option>
                            <option value="song">Song Name</option>
                            <option value="album">Album Name</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" id="exportBtn">üìä Export Filtered Data</button>
                <button class="btn btn-secondary" id="clearFilters">üîÑ Clear Filters</button>
                <button class="btn btn-secondary" id="copyAllBtn">üìã Copy All Visible</button>
            </div>

            <div class="chart-container">
                <div class="chart-title">üìà Top Artists</div>
                <div id="topArtistsChart"></div>
            </div>

            <div class="songs-container">
                <div class="songs-header">
                    <span></span>
                    <span>Song</span>
                    <span class="desktop-only">Album</span>
                    <span class="desktop-only">Date Added</span>
                    <span class="desktop-only">Popularity</span>
                    <span>Actions</span>
                </div>
                <div id="songsList">
                    <!-- Songs will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let songsData = [];
        let filteredData = [];

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const loading = document.getElementById('loading');
        const dataSection = document.getElementById('dataSection');

        fileInput.addEventListener('change', handleFile);
        uploadSection.addEventListener('click', () => fileInput.click());
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--primary-color)';
        });
        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--border-color)';
        });
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--border-color)';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile({ target: { files } });
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showToast('Please select a CSV file', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large. Please select a file under 10MB', 'error');
                return;
            }

            uploadSection.classList.add('hidden');
            loading.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => parseCSV(e.target.result);
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                songsData = lines.slice(1).map((line, index) => {
                    const values = parseCSVLine(line);
                    const song = {};
                    
                    headers.forEach((header, i) => {
                        let value = values[i] || '';
                        value = value.replace(/"/g, '').trim();
                        
                        // Type conversion
                        if (header === 'Track Duration (ms)' || header === 'Popularity' || header === 'Track Number' || header === 'Disc Number') {
                            value = parseInt(value) || 0;
                        } else if (header === 'Explicit') {
                            value = value.toLowerCase() === 'true';
                        } else if (header === 'Added At') {
                            value = new Date(value);
                        }
                        
                        song[header] = value;
                    });
                    
                    return song;
                }).filter(song => song['Track Name']); // Filter out empty rows

                setTimeout(() => {
                    loading.classList.add('hidden');
                    dataSection.classList.remove('hidden');
                    displayData();
                    setupEventListeners();
                    showToast(`Loaded ${songsData.length} songs successfully!`);
                }, 1000);
            } catch (error) {
                loading.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                showToast('Error parsing CSV file. Please check the format.', 'error');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function displayData() {
            displayStats();
            setupFilters();
            filterAndDisplaySongs();
            createTopArtistsChart();
        }

        function displayStats() {
            const stats = calculateStats();
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalSongs}</div>
                    <div class="stat-label">Total Songs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.uniqueArtists}</div>
                    <div class="stat-label">Unique Artists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.uniqueAlbums}</div>
                    <div class="stat-label">Unique Albums</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalDuration}</div>
                    <div class="stat-label">Total Duration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgPopularity}%</div>
                    <div class="stat-label">Avg Popularity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.yearRange}</div>
                    <div class="stat-label">Year Range</div>
                </div>
            `;
        }

        function calculateStats() {
            const artists = new Set();
            const albums = new Set();
            let totalDuration = 0;
            let totalPopularity = 0;
            const years = [];

            songsData.forEach(song => {
                if (song['Artist Name(s)']) artists.add(song['Artist Name(s)']);
                if (song['Album Name']) albums.add(song['Album Name']);
                totalDuration += song['Track Duration (ms)'] || 0;
                totalPopularity += song['Popularity'] || 0;
                
                if (song['Album Release Date']) {
                    const year = new Date(song['Album Release Date']).getFullYear();
                    if (year && !isNaN(year)) years.push(year);
                }
            });

            const hours = Math.round(totalDuration / (1000 * 60 * 60));
            const avgPopularity = Math.round(totalPopularity / songsData.length);
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            const yearRange = `${minYear}-${maxYear}`;

            return {
                totalSongs: songsData.length,
                uniqueArtists: artists.size,
                uniqueAlbums: albums.size,
                totalDuration: `${hours}h`,
                avgPopularity,
                yearRange
            };
        }

        function setupFilters() {
            // Populate year filter
            const years = [...new Set(songsData.map(song => {
                if (song['Album Release Date']) {
                    const year = new Date(song['Album Release Date']).getFullYear();
                    return !isNaN(year) ? year : null;
                }
                return null;
            }).filter(year => year !== null))].sort((a, b) => b - a);

            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });

            // Setup popularity range display
            const popularityFilter = document.getElementById('popularityFilter');
            const popularityValue = document.getElementById('popularityValue');
            popularityFilter.addEventListener('input', () => {
                popularityValue.textContent = popularityFilter.value;
                filterAndDisplaySongs();
            });
        }

        function filterAndDisplaySongs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const yearFilter = document.getElementById('yearFilter').value;
            const popularityFilter = parseInt(document.getElementById('popularityFilter').value);
            const sortBy = document.getElementById('sortBy').value;

            filteredData = songsData.filter(song => {
                const matchesSearch = !searchTerm || 
                    (song['Track Name'] && song['Track Name'].toLowerCase().includes(searchTerm)) ||
                    (song['Artist Name(s)'] && song['Artist Name(s)'].toLowerCase().includes(searchTerm)) ||
                    (song['Album Name'] && song['Album Name'].toLowerCase().includes(searchTerm));

                const matchesYear = !yearFilter || 
                    (song['Album Release Date'] && new Date(song['Album Release Date']).getFullYear().toString() === yearFilter);

                const matchesPopularity = (song['Popularity'] || 0) >= popularityFilter;

                return matchesSearch && matchesYear && matchesPopularity;
            });

            // Sort data
            filteredData.sort((a, b) => {
                switch (sortBy) {
                    case 'popularity':
                        return (b['Popularity'] || 0) - (a['Popularity'] || 0);
                    case 'artist':
                        return (a['Artist Name(s)'] || '').localeCompare(b['Artist Name(s)'] || '');
                    case 'song':
                        return (a['Track Name'] || '').localeCompare(b['Track Name'] || '');
                    case 'album':
                        return (a['Album Name'] || '').localeCompare(b['Album Name'] || '');
                    case 'added':
                    default:
                        return new Date(b['Added At'] || 0) - new Date(a['Added At'] || 0);
                }
            });

            displaySongs(filteredData);
        }

        function displaySongs(songs) {
            const songsList = document.getElementById('songsList');
            
            if (songs.length === 0) {
                songsList.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">No songs match your filters</div>';
                return;
            }

            songsList.innerHTML = songs.map((song, index) => `
                <div class="song-item">
                    <img src="${song['Album Image URL'] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjMjgyODI4Ii8+CjxwYXRoIGQ9Ik0yNSAxNUM4MC4yODEgMTUgMzUgMjAuMDI5NCAzNSAyNUMzNSAyOS45NzA2IDMwLjI4MSAzNSAyNSAzNUMxOS43MTkgMzUgMTUgMjkuOTcwNiAxNSAyNUMxNSAyMC4wMjk0IDE5LjcxOSAxNSAyNSAxNVoiIGZpbGw9IiMxREI5NTQiLz4KPC9zdmc+'}" alt="Album Art" class="album-art" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjMjgyODI4Ii8+CjxwYXRoIGQ9Ik0yNSAxNUM4MC4yODEgMTUgMzUgMjAuMDI5NCAzNSAyNUMzNSAyOS45NzA2IDMwLjI4MSAzNSAyNSAzNUMxOS43MTkgMzUgMTUgMjkuOTcwNiAxNSAyNUMxNSAyMC4wMjk0IDE5LjcxOSAxNSAyNSAxNVoiIGZpbGw9IiMxREI5NTQiLz4KPC9zdmc+'">
                    <div class="song-info">
                        <h3 onclick="copyToClipboard('${escapeHtml(song['Track Name'] || '')}')">${song['Track Name'] || 'Unknown Track'}</h3>
                        <p>${song['Artist Name(s)'] || 'Unknown Artist'}</p>
                    </div>
                    <div class="desktop-only">${song['Album Name'] || 'Unknown Album'}</div>
                    <div class="desktop-only">${formatDate(song['Added At'])}</div>
                    <div class="desktop-only">
                        <div class="popularity-bar">
                            <div class="popularity-fill" style="width: ${song['Popularity'] || 0}%"></div>
                        </div>
                        <small>${song['Popularity'] || 0}%</small>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('${escapeHtml(song['Track Name'] || '')} - ${escapeHtml(song['Artist Name(s)'] || '')}')">üìã</button>
                </div>
            `).join('');
        }

        function createTopArtistsChart() {
            const artistCounts = {};
            songsData.forEach(song => {
                const artist = song['Artist Name(s)'];
                if (artist) {
                    artistCounts[artist] = (artistCounts[artist] || 0) + 1;
                }
            });

            const topArtists = Object.entries(artistCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const chartContainer = document.getElementById('topArtistsChart');
            const maxCount = topArtists[0]?.[1] || 1;

            chartContainer.innerHTML = topArtists.map(([artist, count]) => `
                <div style="display: flex; align-items: center; margin-bottom: 12px; gap: 10px;">
                    <div style="width: 150px; font-size: 0.9rem; color: var(--text-primary); text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" title="${escapeHtml(artist)}">${artist}</div>
                    <div style="flex: 1; height: 20px; background: var(--border-color); border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); width: ${(count / maxCount) * 100}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="width: 40px; text-align: right; font-size: 0.9rem; color: var(--text-secondary);">${count}</div>
                </div>
            `).join('');
        }

        function setupEventListeners() {
            // Search and filter events
            document.getElementById('searchInput').addEventListener('input', filterAndDisplaySongs);
            document.getElementById('yearFilter').addEventListener('change', filterAndDisplaySongs);
            document.getElementById('sortBy').addEventListener('change', filterAndDisplaySongs);

            // Clear filters
            document.getElementById('clearFilters').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('yearFilter').value = '';
                document.getElementById('popularityFilter').value = '0';
                document.getElementById('popularityValue').textContent = '0';
                document.getElementById('sortBy').value = 'added';
                filterAndDisplaySongs();
                showToast('Filters cleared!');
            });

            // Export data
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // Copy all visible songs
            document.getElementById('copyAllBtn').addEventListener('click', () => {
                const songList = filteredData.map(song => 
                    `${song['Track Name'] || 'Unknown'} - ${song['Artist Name(s)'] || 'Unknown'}`
                ).join('\n');
                copyToClipboard(songList);
                showToast(`Copied ${filteredData.length} songs to clipboard!`);
            });
        }

        function exportData() {
            const csvContent = generateCSV(filteredData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `spotify_filtered_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast(`Exported ${filteredData.length} songs to CSV!`);
        }

        function generateCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    if (value === null || value === undefined) value = '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function copyToClipboard(text) {
            if (!text) return;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Copied to clipboard!');
            });
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return 'Unknown';
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatDuration(ms) {
            if (!ms) return '0:00';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'f':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                    case 'e':
                        e.preventDefault();
                        if (!dataSection.classList.contains('hidden')) {
                            exportData();
                        }
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                document.getElementById('searchInput').blur();
            }
        });

        // Add some sample data display when no file is uploaded
        function showSampleData() {
            const sampleStats = `
                <div class="stat-card">
                    <div class="stat-value">457</div>
                    <div class="stat-label">Sample Songs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">234</div>
                    <div class="stat-label">Unique Artists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">198</div>
                    <div class="stat-label">Unique Albums</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">32h</div>
                    <div class="stat-label">Total Duration</div>
                </div>
            `;
            
            // You can uncomment this to show sample data on load
            // document.getElementById('statsGrid').innerHTML = sampleStats;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Focus on upload area when page loads
            fileInput.focus();
        });

        // Add smooth scrolling for better UX
        function smoothScrollTo(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start' 
                });
            }
        }

        // Add advanced filtering options
        function addAdvancedFilters() {
            const advancedFilters = `
                <div class="filter-group">
                    <label for="durationFilter">Duration Range</label>
                    <select id="durationFilter">
                        <option value="">All Durations</option>
                        <option value="short">Short (< 3 min)</option>
                        <option value="medium">Medium (3-5 min)</option>
                        <option value="long">Long (> 5 min)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="explicitFilter">Content</label>
                    <select id="explicitFilter">
                        <option value="">All Content</option>
                        <option value="explicit">Explicit Only</option>
                        <option value="clean">Clean Only</option>
                    </select>
                </div>
            `;
            
            // This can be added to enhance filtering capabilities
        }

        // Performance optimization for large datasets
        function virtualizeList() {
            // Implementation for virtual scrolling would go here
            // This helps with performance when displaying thousands of songs
        }

        // Add export format options
        function showExportOptions() {
            const exportMenu = document.createElement('div');
            exportMenu.className = 'export-menu';
            exportMenu.innerHTML = `
                <button onclick="exportAsJSON()">Export as JSON</button>
                <button onclick="exportAsCSV()">Export as CSV</button>
                <button onclick="exportPlaylist()">Export Playlist</button>
            `;
            // Implementation would go here
        }

        // Add more chart types
        function createChartsSection() {
            // Could add: Release year distribution, Popularity distribution, 
            // Album type breakdown, Duration analysis, etc.
        }
    </script>
</body>
</html>